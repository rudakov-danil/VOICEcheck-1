<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOICEcheck - Организации</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css?v=8">
    <style>
        .org-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .org-context {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .org-badge {
            background: #e0e7ff;
            color: #1e3a5f;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .org-switcher {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .org-switcher select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn-create {
            background: #1e3a5f;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-create:hover {
            background: #2d5a87;
        }

        .org-section {
            margin-bottom: 32px;
        }

        .org-section h3 {
            margin-bottom: 16px;
            font-size: 18px;
            color: #1e3a5f;
        }

        .members-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .member-item:last-child {
            border-bottom: none;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            background: #e0e7ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: 600;
            color: #1e3a5f;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            color: #1e3a5f;
        }

        .member-email {
            font-size: 13px;
            color: #64748b;
        }

        .member-role {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .member-role.owner {
            background: #fef3c7;
            color: #92400e;
        }

        .member-role.admin {
            background: #e0e7ff;
            color: #4338ca;
        }

        .member-role.member {
            background: #f1f5f9;
            color: #475569;
        }

        .member-role.viewer {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .member-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
        }

        .btn-icon:hover {
            color: #1e3a5f;
        }

        .btn-icon.delete:hover {
            color: #ef4444;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 450px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e3a5f;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #334155;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-primary {
            background: #1e3a5f;
            color: white;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .stat-label {
            font-size: 13px;
            color: #64748b;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">VOICEcheck</h1>
                <p class="app-subtitle">Управление организациями</p>
            </div>
            <div class="header-actions">
                <a href="/" class="btn-text">На главную</a>
                <button onclick="logout()" class="btn-text">Выйти</button>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-btn" onclick="location.href='/'">Диалоги</button>
            <button class="tab-btn" onclick="location.href='/organizations.html'">Организации</button>
        </nav>

        <main class="tab-content">
            <div class="tab-pane active">
                <div class="container">
                    <!-- Organization Context -->
                    <div class="org-header">
                        <div class="org-context">
                            <div class="org-switcher">
                                <span>Организация:</span>
                                <select id="orgSwitcher" onchange="switchOrganization(this.value)">
                                    <option value="">Загрузка...</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <button class="btn-create" onclick="openCreateOrgModal()">+ Новая организация</button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-value" id="statMembers">-</div>
                            <div class="stat-label">Участников</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statDialogs">-</div>
                            <div class="stat-label">Диалогов</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statOwners">-</div>
                            <div class="stat-label">Владельцев</div>
                        </div>
                    </div>

                    <!-- Members Section -->
                    <div class="org-section">
                        <h3>Участники</h3>
                        <div class="members-list" id="membersList">
                            <div class="empty-state">
                                <div class="empty-state-icon">...</div>
                                <div>Загрузка...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Member Modal -->
    <div class="modal" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавить участника</h3>
                <button class="close-btn" onclick="closeModal('addMemberModal')">&times;</button>
            </div>
            <div id="addMemberError" class="error-message" style="display: none;"></div>
            <form id="addMemberForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="memberEmail" required placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Полное имя</label>
                    <input type="text" class="form-input" id="memberName" required placeholder="Иван Иванов">
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="memberPassword" required minlength="8" placeholder="Минимум 8 символов">
                </div>
                <div class="form-group">
                    <label class="form-label">Роль</label>
                    <select class="form-select" id="memberRole">
                        <option value="member">Участник</option>
                        <option value="admin">Администратор</option>
                        <option value="viewer">Зритель</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Existing User Modal -->
    <div class="modal" id="addExistingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавить существующего пользователя</h3>
                <button class="close-btn" onclick="closeModal('addExistingModal')">&times;</button>
            </div>
            <div id="addExistingError" class="error-message" style="display: none;"></div>
            <form id="addExistingForm">
                <div class="form-group">
                    <label class="form-label">Email пользователя</label>
                    <input type="email" class="form-input" id="existingEmail" required placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Роль</label>
                    <select class="form-select" id="existingRole">
                        <option value="member">Участник</option>
                        <option value="admin">Администратор</option>
                        <option value="viewer">Зритель</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addExistingModal')">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Organization Modal -->
    <div class="modal" id="createOrgModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Новая организация</h3>
                <button class="close-btn" onclick="closeModal('createOrgModal')">&times;</button>
            </div>
            <div id="createOrgError" class="error-message" style="display: none;"></div>
            <form id="createOrgForm">
                <div class="form-group">
                    <label class="form-label">Название организации</label>
                    <input type="text" class="form-input" id="orgName" required placeholder="Моя компания">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createOrgModal')">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let currentOrgId = null;

        // Initialize
        window.addEventListener('load', async () => {
            await initAuth();
        });

        async function initAuth() {
            // Check if we have a token
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/static/auth.html';
                return;
            }

            // Load organizations
            await loadOrganizations();
            await loadCurrentOrg();
        }

        async function loadOrganizations() {
            try {
                const orgs = await api.get('/auth/organizations');
                const switcher = document.getElementById('orgSwitcher');
                switcher.innerHTML = orgs.map(org =>
                    `<option value="${org.id}">${escapeHtml(org.name)}</option>`
                ).join('');
            } catch (err) {
                console.error('Failed to load organizations:', err);
            }
        }

        async function loadCurrentOrg() {
            const currentOrg = JSON.parse(localStorage.getItem('current_org') || '{}');
            if (currentOrg.id) {
                currentOrgId = currentOrg.id;
                document.getElementById('orgSwitcher').value = currentOrg.id;
                await loadOrgData(currentOrg.id);
            }
        }

        async function switchOrganization(orgId) {
            if (!orgId) return;

            try {
                const data = await api.post(`/auth/select-organization/${orgId}`, {});

                // Update tokens
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);

                // Get org details
                const orgs = await api.get('/auth/organizations');
                const currentOrg = orgs.find(o => o.id === orgId);
                if (currentOrg) {
                    localStorage.setItem('current_org', JSON.stringify(currentOrg));
                }

                currentOrgId = orgId;
                await loadOrgData(orgId);
            } catch (err) {
                console.error('Failed to switch organization:', err);
            }
        }

        async function loadOrgData(orgId) {
            // Load members
            await loadMembers(orgId);
            // Load stats
            await loadStats(orgId);
        }

        async function loadMembers(orgId) {
            try {
                const members = await api.get(`/organizations/${orgId}/members`);
                renderMembers(members);
            } catch (err) {
                console.error('Failed to load members:', err);
                document.getElementById('membersList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">!</div>
                        <div>Ошибка загрузки участников</div>
                    </div>
                `;
            }
        }

        function renderMembers(members) {
            const container = document.getElementById('membersList');
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');

            if (members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">+</div>
                        <div>Нет участников</div>
                        <button class="btn-create" onclick="openAddMemberModal()" style="margin-top: 16px;">Добавить</button>
                    </div>
                `;
                return;
            }

            const roleLabels = {
                'owner': 'Владелец',
                'admin': 'Администратор',
                'member': 'Участник',
                'viewer': 'Зритель'
            };

            container.innerHTML = `
                <div style="padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; gap: 12px;">
                    <button class="btn-create" onclick="openAddMemberModal()" style="font-size: 13px; padding: 8px 16px;">+ Создать пользователя</button>
                    <button class="btn-secondary" onclick="openAddExistingModal()" style="font-size: 13px; padding: 8px 16px; border: 1px solid #e2e8f0; background: white; border-radius: 8px; cursor: pointer;">+ Существующий</button>
                </div>
                ${members.map(m => `
                    <div class="member-item">
                        <div class="member-avatar">${m.full_name.charAt(0).toUpperCase()}</div>
                        <div class="member-info">
                            <div class="member-name">${escapeHtml(m.full_name)}</div>
                            <div class="member-email">${escapeHtml(m.email)}</div>
                        </div>
                        <span class="member-role ${m.role}">${roleLabels[m.role] || m.role}</span>
                        ${m.id !== currentUser.id ? `
                            <div class="member-actions">
                                <button class="btn-icon" onclick="changeRole('${m.id}', '${m.role}')" title="Изменить роль">...</button>
                                <button class="btn-icon delete" onclick="removeMember('${m.id}', '${escapeHtml(m.full_name)}')" title="Удалить">&times;</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;
        }

        async function loadStats(orgId) {
            try {
                const stats = await api.get(`/organizations/${orgId}/stats`);
                document.getElementById('statMembers').textContent = stats.total_members;
                document.getElementById('statDialogs').textContent = stats.dialogs;
                document.getElementById('statOwners').textContent = stats.owners;
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        // Add member
        function openAddMemberModal() {
            document.getElementById('addMemberForm').reset();
            hideError('addMemberError');
            openModal('addMemberModal');
        }

        function openAddExistingModal() {
            document.getElementById('addExistingForm').reset();
            hideError('addExistingError');
            openModal('addExistingModal');
        }

        document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError('addMemberError');

            const email = document.getElementById('memberEmail').value.trim();
            const name = document.getElementById('memberName').value.trim();
            const password = document.getElementById('memberPassword').value;
            const role = document.getElementById('memberRole').value;

            try {
                await api.post(`/organizations/${currentOrgId}/members`, {
                    email,
                    password,
                    full_name: name,
                    role
                });

                closeModal('addMemberModal');
                await loadMembers(currentOrgId);
                await loadStats(currentOrgId);
            } catch (err) {
                showError('addMemberError', err.message || 'Ошибка добавления пользователя');
            }
        });

        document.getElementById('addExistingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError('addExistingError');

            const email = document.getElementById('existingEmail').value.trim();
            const role = document.getElementById('existingRole').value;

            try {
                await api.post(`/organizations/${currentOrgId}/add-existing`, {
                    email,
                    role
                });

                closeModal('addExistingModal');
                await loadMembers(currentOrgId);
                await loadStats(currentOrgId);
            } catch (err) {
                showError('addExistingError', err.message || 'Ошибка добавления пользователя');
            }
        });

        // Create organization
        function openCreateOrgModal() {
            document.getElementById('createOrgForm').reset();
            hideError('createOrgError');
            openModal('createOrgModal');
        }

        document.getElementById('createOrgForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError('createOrgError');

            const name = document.getElementById('orgName').value.trim();

            try {
                await api.post('/organizations', { name });
                closeModal('createOrgModal');
                await loadOrganizations();
                // Switch to new org
                await switchOrganization(document.getElementById('orgSwitcher').lastElementChild.value);
            } catch (err) {
                showError('createOrgError', err.message || 'Ошибка создания организации');
            }
        });

        // Change role
        async function changeRole(userId, currentRole) {
            const newRole = prompt('Новая роль (owner/admin/member/viewer):', currentRole);
            if (!newRole || !['owner', 'admin', 'member', 'viewer'].includes(newRole)) {
                return;
            }

            try {
                await api.patch(`/organizations/${currentOrgId}/members/${userId}/role`, { role: newRole });
                await loadMembers(currentOrgId);
            } catch (err) {
                alert(err.message || 'Ошибка изменения роли');
            }
        }

        // Remove member
        async function removeMember(userId, name) {
            if (!confirm(`Удалить пользователя "${name}" из организации?`)) {
                return;
            }

            try {
                await api.delete(`/organizations/${currentOrgId}/members/${userId}`);
                await loadMembers(currentOrgId);
                await loadStats(currentOrgId);
            } catch (err) {
                alert(err.message || 'Ошибка удаления пользователя');
            }
        }

        // Modal helpers
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function showError(id, text) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.style.display = 'block';
        }

        function hideError(id) {
            document.getElementById(id).style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            localStorage.removeItem('current_org');
            window.location.href = '/static/auth.html';
        }
    </script>
</body>
</html>
